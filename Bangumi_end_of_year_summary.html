<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangumi 年度小结生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 html2canvas 用于生成图片 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .title-text { word-break: break-word; white-space: normal; line-height: 1.3; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen pb-24">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Bangumi 年度小结生成器</h1>
            <p class="text-gray-400 mt-2">ID 精准填充 · 智能数据同步 · 一键生成长图</p>
        </header>

        <main class="space-y-8">
            <!-- Section 1: Basic Info -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h2 class="text-2xl font-semibold">基本数据</h2>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="bangumi-username" class="save-target bg-gray-700 border border-gray-600 rounded-md p-1.5 text-sm w-32 focus:ring-2 focus:ring-indigo-500" placeholder="输入用户名">
                        <button id="sync-user-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-md text-sm flex items-center transition">
                            <span class="btn-text">同步数据</span>
                            <div class="loader ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="form-group col-span-2 sm:col-span-1 lg:col-span-1">
                        <div class="flex items-center space-x-3 mb-1">
                            <img id="user-avatar-preview" src="https://placehold.co/100x100/1f2937/6b7280?text=User" class="w-10 h-10 rounded-full border-2 border-gray-600 object-cover">
                            <div>
                                <label class="block text-xs text-gray-400">昵称</label>
                                <input type="text" id="user-nickname" class="save-target bg-transparent border-none p-0 text-sm font-semibold text-white w-full focus:ring-0" placeholder="等待同步..." readonly>
                                <input type="hidden" id="user-avatar-url" class="save-target">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="year" class="block text-xs font-medium text-gray-400 mb-1">年份</label>
                        <input type="number" id="year" class="save-target w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500" value="2025">
                    </div>
                    <div class="form-group">
                        <label for="watching-count" class="block text-xs font-medium text-gray-400 mb-1">追番数 (完结)</label>
                        <input type="number" id="watching-count" class="save-target w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500" placeholder="当年播出且看完">
                    </div>
                    <div class="form-group">
                        <label for="watched-count" class="block text-xs font-medium text-gray-400 mb-1">看番数 (阅历)</label>
                        <input type="number" id="watched-count" class="save-target w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500" placeholder="当年看过的总数">
                    </div>
                    <div class="form-group">
                        <label for="rewatched-count" class="block text-xs font-medium text-gray-400 mb-1">补番数 (自动)</label>
                        <input type="number" id="rewatched-count" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 cursor-not-allowed text-gray-300" placeholder="= 看番 - 追番" readonly>
                    </div>
                    <div class="form-group">
                        <label for="total-watched" class="block text-xs font-medium text-gray-400 mb-1">累计看番数</label>
                        <input type="number" id="total-watched" class="save-target w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500" placeholder="历史总计">
                    </div>
                </div>
                <p id="sync-status" class="text-xs text-gray-500 mt-2 italic h-4"></p>
                <p class="text-xs text-green-500 mt-1 hidden" id="save-indicator">已自动保存草稿</p>
            </section>

            <!-- Rankings -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">年度排名</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="rank-air-1" class="manual-container"></div>
                    <div id="rank-end-1" class="manual-container"></div>
                    <div id="rank-end-2" class="manual-container"></div>
                    <div id="rank-end-3" class="manual-container"></div>
                </div>
            </section>

            <!-- Characters -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">年度角色</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="char-female" class="manual-container"></div>
                    <div id="char-male" class="manual-container"></div>
                    <div id="char-other" class="manual-container"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">CP</label>
                        <div class="flex space-x-2">
                            <div id="cp-1" class="w-1/2 manual-container" data-label-hidden="true"></div>
                            <div id="cp-2" class="w-1/2 manual-container" data-label-hidden="true"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Voice Actors -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">年度声优</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="staff-seiyuu-female" class="manual-container"></div>
                    <div id="staff-seiyuu-male" class="manual-container"></div>
                </div>
            </section>

            <!-- Music -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">年度音乐</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="music-op" class="manual-container"></div>
                    <div id="music-ed" class="manual-container"></div>
                    <div id="music-in" class="manual-container"></div>
                    <div id="music-artist" class="manual-container"></div>
                </div>
            </section>

            <!-- Episodes -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h2 class="text-2xl font-semibold">年度单集</h2>
                    <button id="add-episode-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition text-sm">+ 添加单集</button>
                </div>
                <div id="episodes-container" class="space-y-4"></div>
            </section>
            
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 border-t border-gray-800 flex justify-center z-40 shadow-xl">
                 <button id="generate-summary" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-12 rounded-full text-lg shadow-lg transition-transform transform hover:scale-105 flex items-center">
                    <span class="mr-2">✨</span> 生成年度小结图片
                </button>
            </div>
        </main>
    </div>

    <!-- Modals (Smart Input) -->
    <div id="smart-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700 transform transition-all scale-100">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-gray-800 rounded-t-xl">
                <h3 class="text-xl font-bold text-white">添加条目内容</h3>
                <button class="close-modal-btn text-gray-400 hover:text-white text-2xl leading-none transition">&times;</button>
            </div>
            <div class="p-6">
                <div class="flex space-x-4 border-b border-gray-700 mb-4">
                    <button class="tab-btn px-4 py-2 text-indigo-400 border-b-2 border-indigo-500 font-medium" data-tab="id">ID 自动获取</button>
                    <button class="tab-btn px-4 py-2 text-gray-400 hover:text-gray-200" data-tab="manual">手动输入</button>
                </div>
                <div id="tab-id" class="tab-content space-y-4">
                    <div class="flex gap-2">
                        <input type="number" id="api-id-input" class="flex-1 bg-gray-700 border border-gray-600 rounded-md p-2.5 focus:ring-2 focus:ring-indigo-500 text-white" placeholder="Bangumi ID">
                        <button id="fetch-api-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 rounded-md font-medium transition flex items-center">获取<div id="api-loader" class="loader ml-2 hidden" style="width: 16px; height: 16px; border-width: 2px;"></div></button>
                    </div>
                    <div id="api-preview" class="hidden mt-4 p-3 bg-gray-700/50 rounded-lg flex gap-3 items-center border border-gray-600">
                        <div class="w-12 h-16 flex items-center justify-center overflow-hidden bg-gray-900">
                            <!-- Preview uses flex + max-size for NO CROP -->
                            <img id="api-preview-img" class="max-w-full max-h-full" style="width:auto;height:auto;">
                        </div>
                        <div class="flex-1 min-w-0"><p id="api-preview-title" class="font-bold text-white truncate"></p></div>
                        <button id="confirm-api-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">使用</button>
                    </div>
                    <p id="api-error" class="hidden text-red-400 text-sm mt-2"></p>
                </div>
                <div id="tab-manual" class="tab-content space-y-4 hidden">
                    <input type="text" id="manual-name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2.5 text-white" placeholder="名称">
                    <input type="text" id="manual-image-url" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2.5 text-white" placeholder="图片URL">
                    <div class="pt-2 text-right"><button id="manual-confirm-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition">确认添加</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="summary-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center p-4 z-50 hidden backdrop-blur-sm">
         <div class="relative w-full max-w-4xl h-full flex flex-col items-center justify-center">
            <button id="close-result-modal" class="absolute top-4 right-4 bg-gray-700 text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl hover:bg-gray-600 z-[60] shadow-lg cursor-pointer">&times;</button>
            <div id="generation-loader" class="flex flex-col items-center justify-center text-white">
                <div class="loader mb-4" style="width: 50px; height: 50px; border-width: 5px;"></div>
                <p class="text-xl font-medium">正在生成高清图片...</p>
            </div>
            <div id="result-container" class="hidden w-full h-full flex flex-col items-center overflow-hidden">
                <div class="text-white mb-4 text-center">
                    <h3 class="text-xl font-bold">生成成功！</h3>
                    <p class="text-sm text-gray-400">电脑端右键“图片另存为”，手机端长按保存</p>
                </div>
                <div class="w-full flex-1 overflow-auto custom-scrollbar flex justify-center bg-gray-900/50 rounded-lg border border-gray-800 p-4" id="image-wrapper"></div>
            </div>
        </div>
    </div>

    <!-- Hidden Rendering Stage -->
    <div id="render-stage" class="absolute top-0 left-[-9999px] z-[-1] w-[900px] bg-gray-900 text-white"></div>

    <script>
        // --- GLOBAL SCOPE VARIABLES ---
        var episodeCounter = 0; // Fixes reference error
        var currentTargetId = null;
        var currentApiType = 'subject';
        var tempApiData = null;

        // Global functions for inline onclick handlers
        window.removeEpisode = function(btn) { 
            btn.closest('.episode-entry').remove(); 
            // Trigger save manually since this is outside the main listener loop mostly
            const event = new Event('input', { bubbles: true });
            document.body.dispatchEvent(event);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const itemConfig = {
                'rank-air-1': { label: '年度排名1 (播出)', type: 'subject' }, 
                'rank-end-1': { label: '年度排名1 (完结)', type: 'subject' },
                'rank-end-2': { label: '年度排名2 (完结)', type: 'subject' }, 
                'rank-end-3': { label: '年度排名3 (完结)', type: 'subject' },
                'char-female': { label: '女性角色', type: 'character' }, 
                'char-male': { label: '男性角色', type: 'character' },
                'char-other': { label: '其他角色', type: 'character' }, 
                'cp-1': { label: 'CP 1', type: 'character' }, 
                'cp-2': { label: 'CP 2', type: 'character' },
                'music-op': { label: 'OP', type: 'subject' }, 
                'music-ed': { label: 'ED', type: 'subject' }, 
                'music-in': { label: 'IN', type: 'subject' },
                'music-artist': { label: '歌手', type: 'person' }, 
                'staff-seiyuu-female': { label: '女性声优', type: 'person' },
                'staff-seiyuu-male': { label: '男性声优', type: 'person' },
            };

            // Init Manual Containers - FIX: Transparent background for placeholder
            document.querySelectorAll('.manual-container').forEach(container => {
                const id = container.id;
                const config = itemConfig[id];
                if (!config) return;
                const showLabel = !container.dataset.labelHidden;
                container.innerHTML = `
                    ${showLabel ? `<label class="block text-sm font-medium text-gray-400 mb-1">${config.label}</label>` : ''}
                    <div class="relative manual-trigger group" data-target-id="${id}" data-api-type="${config.type}">
                        <div class="w-full h-40 bg-transparent rounded-md overflow-hidden border border-gray-700 flex items-center justify-center relative">
                            <!-- Image Container: Hidden by default -->
                            <div id="img-container-${id}" class="w-full h-full hidden flex items-center justify-center">
                                <img id="img-${id}" class="save-target-img max-w-full max-h-full" style="width: auto; height: auto;">
                            </div>
                            <!-- Placeholder -->
                            <div id="placeholder-${id}" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 group-hover:text-indigo-400 transition-colors bg-gray-800/30">
                                 <svg class="w-8 h-8 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                 <span class="text-xs">点击添加</span>
                            </div>
                        </div>
                        <input type="hidden" id="data-name-${id}" class="save-target"><input type="hidden" id="data-img-${id}" class="save-target">
                    </div>`;
            });

            // Input Elements
            const inputs = {
                year: document.getElementById('year'),
                watching: document.getElementById('watching-count'),
                watched: document.getElementById('watched-count'),
                rewatched: document.getElementById('rewatched-count'),
                total: document.getElementById('total-watched'),
                username: document.getElementById('bangumi-username'),
                nickname: document.getElementById('user-nickname'),
                avatar: document.getElementById('user-avatar-preview'),
                avatarHidden: document.getElementById('user-avatar-url')
            };
            const episodesContainer = document.getElementById('episodes-container');
            const summaryModal = document.getElementById('summary-modal');
            const smartModal = document.getElementById('smart-modal');
            const resultContainer = document.getElementById('result-container');
            const imageWrapper = document.getElementById('image-wrapper');
            const loader = document.getElementById('generation-loader');
            const renderStage = document.getElementById('render-stage');
            const syncStatus = document.getElementById('sync-status');

            // --- Helper: Update Image Display ---
            function updateImageDisplay(id, url) {
                const img = document.getElementById(`img-${id}`);
                const container = document.getElementById(`img-container-${id}`);
                const ph = document.getElementById(`placeholder-${id}`);
                if (img && container && ph) {
                    img.src = url;
                    container.classList.remove('hidden');
                    ph.classList.add('hidden');
                }
            }

            // --- State Management ---
            function saveState() {
                const state = { inputs: {}, episodes: [] };
                document.querySelectorAll('.save-target').forEach(el => state.inputs[el.id] = el.value);
                document.querySelectorAll('.episode-entry').forEach((entry) => {
                    const id = entry.id.split('-')[1];
                    const animeId = `ep-anime-${id}`;
                    state.episodes.push({
                        name: document.getElementById(`data-name-${animeId}`)?.value || '',
                        img: document.getElementById(`data-img-${animeId}`)?.value || '',
                        number: document.getElementById(`ep-number-${id}`)?.value || ''
                    });
                });
                localStorage.setItem('bgm_summary_state_v9', JSON.stringify(state));
                document.getElementById('save-indicator').classList.remove('hidden');
                setTimeout(() => document.getElementById('save-indicator').classList.add('hidden'), 2000);
            }

            function loadState() {
                const saved = localStorage.getItem('bgm_summary_state_v9');
                if (!saved) return;
                try {
                    const state = JSON.parse(saved);
                    Object.entries(state.inputs).forEach(([id, val]) => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.value = val;
                            if (id.startsWith('data-img-') && val) updateImageDisplay(id.replace('data-img-', ''), val);
                        }
                    });
                    if (state.inputs['user-avatar-url']) inputs.avatar.src = state.inputs['user-avatar-url'];
                    episodesContainer.innerHTML = '';
                    state.episodes.forEach(ep => addEpisode(ep));
                    calculateRewatched();
                } catch(e) { console.error(e); }
            }
            document.body.addEventListener('input', (e) => {
                if (e.target.matches('input') || e.target.matches('.save-target')) saveState();
            });

            // --- Sync Logic (FIXED: NO CUSTOM HEADERS to avoid CORS issues) ---
            async function fetchUserStats(username, targetYear) {
                let finishedThisYear = 0; 
                let newShowsFinished = 0; 
                const limit = 50; 
                let page = 0;
                let hasMore = true;
                const maxPages = 100; 
                const targetYearInt = parseInt(targetYear, 10);

                while (hasMore && page < maxPages) {
                    try {
                        if (syncStatus) syncStatus.textContent = `正在扫描第 ${page + 1} 页历史数据...`;
                        const offset = page * limit;
                        // NO HEADERS
                        const res = await fetch(`https://api.bgm.tv/v0/users/${username}/collections?subject_type=2&type=2&limit=${limit}&offset=${offset}`);
                        if (!res.ok) break;
                        const data = await res.json();
                        if (data.data.length === 0) { hasMore = false; break; }

                        for (const item of data.data) {
                            const updated = item.updated_at || ""; 
                            const itemYearStr = updated.substring(0, 4);
                            const itemYearInt = parseInt(itemYearStr, 10);
                            
                            if (itemYearInt > targetYearInt) { continue; } 
                            else if (itemYearInt === targetYearInt) {
                                finishedThisYear++;
                                const airDate = item.subject?.date || "";
                                if (airDate.startsWith(targetYear)) { newShowsFinished++; }
                            } else if (itemYearInt < targetYearInt) { hasMore = false; break; }
                        }
                        if (data.data.length < limit) hasMore = false;
                        page++;
                    } catch (e) { console.error(e); break; }
                }
                return { finishedThisYear, newShowsFinished };
            }

            document.getElementById('sync-user-btn').addEventListener('click', async () => {
                const username = inputs.username.value.trim();
                const targetYear = inputs.year.value.toString();
                if (!username) { alert("请输入 Bangumi 用户名"); return; }
                
                const btn = document.getElementById('sync-user-btn');
                const btnText = btn.querySelector('.btn-text');
                const loader = btn.querySelector('.loader');
                btnText.textContent = "同步中...";
                loader.classList.remove('hidden');
                btn.disabled = true;

                try {
                    // Profile
                    const userRes = await fetch(`https://api.bgm.tv/v0/users/${username}`);
                    if (!userRes.ok) throw new Error("用户未找到");
                    const userData = await userRes.json();
                    
                    inputs.nickname.value = userData.nickname;
                    inputs.avatar.src = userData.avatar.large;
                    inputs.avatarHidden.value = userData.avatar.large; 

                    // Total
                    const totalRes = await fetch(`https://api.bgm.tv/v0/users/${username}/collections?subject_type=2&type=2&limit=1`);
                    const totalData = await totalRes.json();
                    if (totalData.total !== undefined) { inputs.total.value = totalData.total; }

                    // Stats
                    const stats = await fetchUserStats(username, targetYear);
                    inputs.watched.value = stats.finishedThisYear;
                    inputs.watching.value = stats.newShowsFinished;
                    
                    calculateRewatched();
                    saveState(); 
                    syncStatus.textContent = "同步完成！";
                } catch (error) {
                    syncStatus.textContent = "同步失败: " + error.message;
                } finally {
                    btnText.textContent = "同步数据";
                    loader.classList.add('hidden');
                    btn.disabled = false;
                    setTimeout(() => { syncStatus.textContent = ""; }, 5000);
                }
            });

            function calculateRewatched() {
                const diff = (parseInt(inputs.watched.value)||0) - (parseInt(inputs.watching.value)||0);
                inputs.rewatched.value = diff > 0 ? diff : 0;
            }
            inputs.watched.addEventListener('input', calculateRewatched);
            inputs.watching.addEventListener('input', calculateRewatched);

            // --- Generate Image Logic ---
            document.getElementById('generate-summary').addEventListener('click', async () => {
                const data = {
                    year: inputs.year.value || '2025',
                    watching: inputs.watching.value || '0',
                    watched: inputs.watched.value || '0',
                    rewatched: inputs.rewatched.value || '0',
                    total: inputs.total.value || '0',
                    nickname: inputs.nickname.value || inputs.username.value,
                    avatar: inputs.avatar.src,
                    items: {},
                    episodes: []
                };
                Object.keys(itemConfig).forEach(id => {
                    data.items[id] = {
                        name: document.getElementById(`data-name-${id}`).value,
                        img: document.getElementById(`data-img-${id}`).value
                    };
                });
                document.querySelectorAll('.episode-entry').forEach(entry => {
                    const id = entry.id.split('-')[1];
                    const animeId = `ep-anime-${id}`;
                    const name = document.getElementById(`data-name-${animeId}`)?.value;
                    if(name) {
                        data.episodes.push({
                            name: name,
                            img: document.getElementById(`data-img-${animeId}`)?.value,
                            number: document.getElementById(`ep-number-${id}`)?.value
                        });
                    }
                });

                renderStage.innerHTML = getTemplateHTML(data);
                
                // Preload
                const imgs = renderStage.querySelectorAll('img');
                const promises = Array.from(imgs).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
                });

                summaryModal.classList.remove('hidden');
                resultContainer.classList.add('hidden');
                loader.classList.remove('hidden');

                await Promise.all(promises);
                await new Promise(r => setTimeout(r, 800));

                try {
                    const canvas = await html2canvas(renderStage, {
                        useCORS: true,
                        scale: 3, 
                        backgroundColor: '#111827',
                        width: 900,
                        windowWidth: 900
                    });
                    const img = new Image();
                    img.src = canvas.toDataURL('image/png');
                    img.className = "w-auto max-w-full h-auto rounded-lg shadow-2xl border border-gray-700";
                    imageWrapper.innerHTML = '';
                    imageWrapper.appendChild(img);
                    loader.classList.add('hidden');
                    resultContainer.classList.remove('hidden');
                } catch (e) {
                    console.error(e);
                    alert("生成失败");
                    summaryModal.classList.add('hidden');
                }
            });

            // --- HTML Template (Fixed Black Background) ---
            function getTemplateHTML(data) {
                const toCors = (url) => url && !url.includes('placehold') && !url.startsWith('data') 
                    ? `https://images.weserv.nl/?url=${encodeURIComponent(url)}&output=webp&w=400` 
                    : (url || 'https://placehold.co/300x400/1f2937/374151?text=Empty');

                const cardItem = (id) => {
                    const item = data.items[id];
                    return `
                    <div class="flex flex-col items-center bg-gray-800 rounded-lg p-3 border border-gray-700 h-full">
                        <div class="w-full h-52 rounded-md overflow-hidden flex items-center justify-center mb-2 bg-transparent">
                            <img src="${toCors(item?.img)}" class="max-w-full max-h-full" style="width: auto; height: auto;" crossorigin="anonymous">
                        </div>
                        <div class="min-h-[2.5rem] flex items-center justify-center w-full">
                            <p class="text-sm font-bold text-center leading-tight text-gray-200 title-text w-full">${item?.name || '-'}</p>
                        </div>
                    </div>`;
                };

                const cpCard = () => {
                    const i1 = data.items['cp-1'], i2 = data.items['cp-2'];
                    const n1 = i1?.name || '';
                    const n2 = i2?.name || '';
                    const cpName = (n1 && n2) ? `${n1} x ${n2}` : 'CP';
                    
                    return `
                    <div class="col-span-1 bg-gray-800 rounded-lg p-3 border border-gray-700 flex flex-col items-center justify-between h-full">
                        <div class="flex justify-center items-end h-52 w-full px-0 gap-1">
                            <div class="w-1/2 h-full rounded overflow-hidden flex items-center justify-center bg-transparent">
                                <img src="${toCors(i1?.img)}" class="max-w-full max-h-full" style="width: auto; height: auto;" crossorigin="anonymous">
                            </div>
                            <div class="w-1/2 h-full rounded overflow-hidden flex items-center justify-center bg-transparent">
                                <img src="${toCors(i2?.img)}" class="max-w-full max-h-full" style="width: auto; height: auto;" crossorigin="anonymous">
                            </div>
                        </div>
                        <div class="min-h-[2.5rem] flex items-center justify-center w-full">
                            <p class="text-sm font-bold text-center text-pink-400 w-full title-text">${cpName}</p>
                        </div>
                    </div>`;
                };

                const epItem = (ep) => `
                    <div class="bg-gray-800 rounded-lg p-2 border border-gray-700 h-full flex flex-col">
                        <div class="w-full h-28 rounded mb-2 flex items-center justify-center overflow-hidden bg-transparent">
                            <img src="${toCors(ep.img)}" class="max-w-full max-h-full" style="width: auto; height: auto;" crossorigin="anonymous">
                        </div>
                        <div class="text-center mt-auto">
                            <div class="min-h-[2rem] flex items-center justify-center w-full">
                                <p class="text-xs font-bold text-gray-300 title-text w-full">${ep.name}</p>
                            </div>
                            <p class="text-xs text-indigo-400 font-mono mt-1">Ep.${ep.number}</p>
                        </div>
                    </div>`;

                return `
                <div class="p-8 bg-gray-900 text-white font-sans w-[900px] mx-auto">
                    <div class="flex items-center justify-between border-b-2 border-gray-700 pb-6 mb-8">
                        <div class="flex items-center gap-5">
                            <div class="w-24 h-24 rounded-full border-4 border-indigo-600 bg-gray-800 overflow-hidden flex items-center justify-center">
                                <img src="${toCors(data.avatar)}" class="max-w-full max-h-full" style="width: auto; height: auto;" crossorigin="anonymous">
                            </div>
                            <div>
                                <h1 class="text-5xl font-black italic tracking-tighter text-indigo-500">${data.year}</h1>
                                <div class="text-gray-400 font-medium tracking-widest uppercase text-sm mt-1">Animation Year In Review</div>
                                <div class="text-xl font-bold mt-2 text-white">@${data.nickname}</div>
                            </div>
                        </div>
                        <div class="flex gap-6 text-right">
                            <div><div class="text-3xl font-bold text-white">${data.watching}</div><div class="text-xs text-gray-500 uppercase font-bold">追番</div></div>
                            <div><div class="text-3xl font-bold text-white">${data.rewatched}</div><div class="text-xs text-gray-500 uppercase font-bold">补番</div></div>
                            <div><div class="text-3xl font-bold text-white">${data.watched}</div><div class="text-xs text-gray-500 uppercase font-bold">年度</div></div>
                            <div><div class="text-3xl font-bold text-indigo-400">${data.total}</div><div class="text-xs text-gray-500 uppercase font-bold">累计</div></div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <div class="flex items-center mb-4"><div class="w-1.5 h-6 bg-indigo-500 mr-3"></div><h2 class="text-xl font-bold uppercase tracking-wider">年度动画</h2></div>
                        <div class="grid grid-cols-4 gap-4">${cardItem('rank-air-1')}${cardItem('rank-end-1')}${cardItem('rank-end-2')}${cardItem('rank-end-3')}</div>
                    </div>

                    <div class="mb-8">
                        <div class="flex items-center mb-4"><div class="w-1.5 h-6 bg-pink-500 mr-3"></div><h2 class="text-xl font-bold uppercase tracking-wider">年度角色</h2></div>
                        <div class="grid grid-cols-4 gap-4">${cardItem('char-female')}${cardItem('char-male')}${cardItem('char-other')}${cpCard()}</div>
                    </div>

                    <div class="mb-8">
                        <div class="flex items-center mb-4"><div class="w-1.5 h-6 bg-yellow-500 mr-3"></div><h2 class="text-xl font-bold uppercase tracking-wider">年度声优</h2></div>
                        <div class="grid grid-cols-4 gap-4"><div class="col-start-2">${cardItem('staff-seiyuu-female')}</div><div>${cardItem('staff-seiyuu-male')}</div></div>
                    </div>

                    <div class="mb-8">
                        <div class="flex items-center mb-4"><div class="w-1.5 h-6 bg-green-500 mr-3"></div><h2 class="text-xl font-bold uppercase tracking-wider">年度音乐</h2></div>
                        <div class="grid grid-cols-4 gap-4">${cardItem('music-op')}${cardItem('music-ed')}${cardItem('music-in')}${cardItem('music-artist')}</div>
                    </div>

                    ${data.episodes.length > 0 ? `<div><div class="flex items-center mb-4"><div class="w-1.5 h-6 bg-blue-500 mr-3"></div><h2 class="text-xl font-bold uppercase tracking-wider">年度单集</h2></div><div class="grid grid-cols-5 gap-4">${data.episodes.map(epItem).join('')}</div></div>` : ''}
                    
                    <div class="mt-8 pt-4 border-t border-gray-800 text-center text-gray-600 text-xs uppercase tracking-widest">Generated by Bangumi Summary Tool</div>
                </div>`;
            }

            // --- Episode Add (Fixed scope) ---
            function addEpisode(data={}) {
                episodeCounter++;
                const uniqueId = episodeCounter;
                const animeId = `ep-anime-${uniqueId}`;
                const entry = document.createElement('div');
                entry.className = 'episode-entry flex items-end space-x-4 p-3 bg-gray-700/50 rounded-lg border border-gray-600 mb-4';
                entry.id = `episode-${uniqueId}`;
                const imgDisplayClass = data.img ? '' : 'hidden';
                const placeDisplayClass = data.img ? 'hidden' : '';
                // FIX: Use transparent background for placeholder
                entry.innerHTML = `
                    <div class="w-1/3 manual-container">
                        <label class="block text-xs font-medium text-gray-400 mb-1">动画</label>
                        <div class="relative manual-trigger group" data-target-id="${animeId}" data-api-type="subject">
                            <div class="w-full h-24 bg-transparent rounded-md overflow-hidden border border-gray-700 flex items-center justify-center relative">
                                <div id="img-container-${animeId}" class="w-full h-full ${imgDisplayClass} flex items-center justify-center">
                                    <img id="img-${animeId}" src="${data.img||''}" class="save-target-img max-w-full max-h-full" style="width: auto; height: auto;">
                                </div>
                                <div id="placeholder-${animeId}" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer border border-dashed border-gray-500 text-gray-500 hover:border-indigo-500 ${placeDisplayClass}"><span class="text-xs">添加</span></div>
                            </div>
                            <input type="hidden" id="data-name-${animeId}" class="save-target" value="${data.name||''}"><input type="hidden" id="data-img-${animeId}" class="save-target" value="${data.img||''}">
                        </div>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-400 mb-1">集数</label>
                        <input type="number" id="ep-number-${uniqueId}" class="save-target w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-sm" placeholder="Ep." value="${data.number||''}">
                        <button class="text-red-400 text-xs mt-2 hover:underline" onclick="removeEpisode(this)">删除</button>
                    </div>`;
                episodesContainer.appendChild(entry);
            }
            document.getElementById('add-episode-btn').addEventListener('click', () => { addEpisode(); saveState(); });

            // --- Common Event Listeners ---
            document.querySelectorAll('.close-modal-btn').forEach(b => b.addEventListener('click', () => smartModal.classList.add('hidden')));
            document.getElementById('close-result-modal').addEventListener('click', () => summaryModal.classList.add('hidden'));
            document.body.addEventListener('click', (e) => {
                const trigger = e.target.closest('.manual-trigger');
                if (trigger) {
                    currentTargetId = trigger.dataset.targetId;
                    currentApiType = trigger.dataset.apiType || 'subject';
                    document.getElementById('api-id-input').value = '';
                    document.getElementById('api-preview').classList.add('hidden');
                    document.getElementById('tab-id').classList.remove('hidden');
                    document.getElementById('tab-manual').classList.add('hidden');
                    smartModal.classList.remove('hidden');
                }
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => {
                        b.classList.toggle('text-indigo-400', b === btn);
                        b.classList.toggle('border-indigo-500', b === btn);
                        b.classList.toggle('text-gray-400', b !== btn);
                    });
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('hidden', c.id !== `tab-${btn.dataset.tab}`));
                });
            });
            document.getElementById('fetch-api-btn').addEventListener('click', async () => {
                const id = document.getElementById('api-id-input').value;
                if(!id) return;
                const endpoint = currentApiType === 'subject' ? `https://api.bgm.tv/v0/subjects/${id}` : `https://api.bgm.tv/v0/${currentApiType}s/${id}`;
                try {
                    const res = await fetch(endpoint);
                    if (!res.ok) throw new Error("ID Error");
                    const d = await res.json();
                    const name = d.name_cn || d.name;
                    const img = (d.images?.large || d.images?.medium || '').replace('http:','https:');
                    tempApiData = {name, img};
                    document.getElementById('api-preview-title').textContent = name;
                    document.getElementById('api-preview-img').src = `https://images.weserv.nl/?url=${encodeURIComponent(img)}&output=webp`;
                    document.getElementById('api-preview').classList.remove('hidden');
                } catch(e){ alert("ID Error"); }
            });
            document.getElementById('confirm-api-btn').addEventListener('click', () => {
                if(tempApiData) { updateImageDisplay(currentTargetId, tempApiData.img); document.getElementById(`data-name-${currentTargetId}`).value = tempApiData.name; document.getElementById(`data-img-${currentTargetId}`).value = tempApiData.img; saveState(); smartModal.classList.add('hidden'); }
            });
            document.getElementById('manual-confirm-btn').addEventListener('click', () => {
                const name = document.getElementById('manual-name').value;
                const img = document.getElementById('manual-image-url').value;
                if(name && img) { updateImageDisplay(currentTargetId, img); document.getElementById(`data-name-${currentTargetId}`).value = name; document.getElementById(`data-img-${currentTargetId}`).value = img; saveState(); smartModal.classList.add('hidden'); }
            });

            loadState();
        });
    </script>
</body>
</html>