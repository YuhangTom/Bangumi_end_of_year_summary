<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangumi 年度小结生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 html2canvas 用于生成图片 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .placeholder-image {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='8' ry='8' stroke='%23374151FF' stroke-width='2' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.2s;
        }
        .placeholder-image:hover {
            background-color: rgba(55, 65, 81, 0.5);
            border-color: #6366f1;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 移除 truncate，允许换行 */
        .title-text {
            word-break: break-word;
            white-space: normal;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Bangumi 年度小结生成器</h1>
            <p class="text-gray-400 mt-2">ID 精准填充 · 全历史年份支持 · 自动保存</p>
        </header>

        <main class="space-y-8">
            <!-- Section 1: Basic Info with Auto-Sync -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h2 class="text-2xl font-semibold">基本数据</h2>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="bangumi-username" class="save-target bg-gray-700 border border-gray-600 rounded-md p-1.5 text-sm w-32 focus:ring-2 focus:ring-indigo-500" placeholder="输入用户名">
                        <button id="sync-user-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-md text-sm flex items-center transition">
                            <span class="btn-text">同步数据</span>
                            <div class="loader ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="form-group col-span-2 sm:col-span-1 lg:col-span-1">
                        <div class="flex items-center space-x-3 mb-1">
                            <img id="user-avatar-preview" src="https://placehold.co/100x100/1f2937/6b7280?text=User" class="w-10 h-10 rounded-full border-2 border-gray-600 object-cover">
                            <div>
                                <label class="block text-xs text-gray-400">昵称</label>
                                <input type="text" id="user-nickname" class="save-target bg-transparent border-none p-0 text-sm font-semibold text-white w-full focus:ring-0" placeholder="等待同步..." readonly>
                                <input type="hidden" id="user-avatar-url" class="save-target">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="year" class="block text-xs font-medium text-gray-400 mb-1">年份</label>
                        <input type="number" id="year" class="save-target w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500" value="2025">
                    </div>
                    <div class="form-group">
                        <label for="watching-count" class="block text-xs font-medium text-gray-400 mb-1">追番数 (完结)</label>
                        <input type="number" id="watching-count" class="save-target w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500" placeholder="当年播出且看完">
                    </div>
                    <div class="form-group">
                        <label for="watched-count" class="block text-xs font-medium text-gray-400 mb-1">看番数 (阅历)</label>
                        <input type="number" id="watched-count" class="save-target w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500" placeholder="当年看过的总数">
                    </div>
                    <div class="form-group">
                        <label for="rewatched-count" class="block text-xs font-medium text-gray-400 mb-1">补番数 (自动)</label>
                        <input type="number" id="rewatched-count" class="w-full bg-gray-600 border border-gray-500 rounded-md p-2 cursor-not-allowed text-gray-300" placeholder="= 看番 - 追番" readonly>
                    </div>
                    <div class="form-group">
                        <label for="total-watched" class="block text-xs font-medium text-gray-400 mb-1">累计看番数</label>
                        <input type="number" id="total-watched" class="save-target w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500" placeholder="历史总计">
                    </div>
                </div>
                <p id="sync-status" class="text-xs text-gray-500 mt-2 italic h-4"></p>
                <p class="text-xs text-green-500 mt-1 hidden" id="save-indicator">已自动保存草稿</p>
            </section>

            <!-- Section 2: Rankings -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">年度排名</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="rank-air-1" class="manual-container"></div>
                    <div id="rank-end-1" class="manual-container"></div>
                    <div id="rank-end-2" class="manual-container"></div>
                    <div id="rank-end-3" class="manual-container"></div>
                </div>
            </section>

            <!-- Section 3: Characters & CP -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">年度角色</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="char-female" class="manual-container"></div>
                    <div id="char-male" class="manual-container"></div>
                    <div id="char-other" class="manual-container"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">CP</label>
                        <div class="flex space-x-2">
                            <div id="cp-1" class="w-1/2 manual-container" data-label-hidden="true"></div>
                            <div id="cp-2" class="w-1/2 manual-container" data-label-hidden="true"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Section 4: Music & Voice -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">年度音乐与声优</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="music-op" class="manual-container"></div>
                    <div id="music-ed" class="manual-container"></div>
                    <div id="music-in" class="manual-container"></div>
                    <div id="music-artist" class="manual-container"></div>
                    <div id="staff-seiyuu-female" class="manual-container"></div>
                    <div id="staff-seiyuu-male" class="manual-container"></div>
                </div>
            </section>

            <!-- Section 5: Episodes -->
            <section class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h2 class="text-2xl font-semibold">年度单集</h2>
                    <button id="add-episode-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition text-sm">
                        + 添加单集
                    </button>
                </div>
                <div id="episodes-container" class="space-y-4"></div>
            </section>
            
            <div class="text-center pt-4 pb-8">
                 <button id="generate-summary" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg ring-4 ring-indigo-500/30">
                    预览年度小结
                </button>
            </div>
        </main>
    </div>

    <!-- Smart Input Modal -->
    <div id="smart-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700 transform transition-all scale-100">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-gray-800 rounded-t-xl">
                <h3 class="text-xl font-bold text-white">添加条目内容</h3>
                <button class="close-modal-btn text-gray-400 hover:text-white text-2xl leading-none transition">&times;</button>
            </div>
            
            <div class="p-6">
                <!-- Tabs -->
                <div class="flex space-x-4 border-b border-gray-700 mb-4">
                    <button class="tab-btn px-4 py-2 text-indigo-400 border-b-2 border-indigo-500 font-medium" data-tab="id">ID 自动获取 (推荐)</button>
                    <button class="tab-btn px-4 py-2 text-gray-400 hover:text-gray-200" data-tab="manual">手动输入</button>
                </div>

                <!-- Tab Content: ID -->
                <div id="tab-id" class="tab-content space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Bangumi Subject ID / Person ID</label>
                        <div class="flex gap-2">
                            <input type="number" id="api-id-input" class="flex-1 bg-gray-700 border border-gray-600 rounded-md p-2.5 focus:ring-2 focus:ring-indigo-500 text-white" placeholder="例如: 394597">
                            <button id="fetch-api-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 rounded-md font-medium transition flex items-center">
                                获取
                                <div id="api-loader" class="loader ml-2 hidden" style="width: 16px; height: 16px; border-width: 2px;"></div>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">提示：ID 是网址中 subject/ 或 character/ 后的数字。</p>
                    </div>
                    <!-- Preview Area -->
                    <div id="api-preview" class="hidden mt-4 p-3 bg-gray-700/50 rounded-lg flex gap-3 items-center border border-gray-600">
                        <img id="api-preview-img" src="" class="w-12 h-16 object-cover rounded bg-gray-800">
                        <div class="flex-1 min-w-0">
                            <p id="api-preview-title" class="font-bold text-white truncate"></p>
                            <p class="text-xs text-green-400">获取成功</p>
                        </div>
                        <button id="confirm-api-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">确认使用</button>
                    </div>
                    <p id="api-error" class="hidden text-red-400 text-sm mt-2"></p>
                </div>

                <!-- Tab Content: Manual -->
                <div id="tab-manual" class="tab-content space-y-4 hidden">
                    <div>
                        <label for="manual-name" class="block text-sm font-medium text-gray-300 mb-1">条目名称</label>
                        <input type="text" id="manual-name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2.5 focus:ring-2 focus:ring-indigo-500 text-white" placeholder="例如：孤独摇滚！">
                    </div>
                    <div>
                        <label for="manual-image-url" class="block text-sm font-medium text-gray-300 mb-1">图片地址</label>
                        <input type="text" id="manual-image-url" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2.5 focus:ring-2 focus:ring-indigo-500 text-white" placeholder="粘贴图片链接...">
                    </div>
                    <div class="pt-2 text-right">
                        <button id="manual-confirm-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition">确认添加</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50 hidden backdrop-blur-sm">
         <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col relative border border-gray-700">
            <div class="absolute top-4 right-4 z-20 flex gap-2">
                 <button class="close-modal-btn bg-gray-700/80 text-gray-300 hover:text-white rounded-full w-8 h-8 flex items-center justify-center text-xl leading-none backdrop-blur-md transition hover:bg-gray-600">&times;</button>
            </div>
            <!-- 加载中提示 -->
            <div id="generation-loader" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-gray-800/90 rounded-xl hidden">
                <div class="loader mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div>
                <p class="text-white font-medium">正在生成图片...</p>
                <p class="text-gray-400 text-sm mt-2">首次加载图片可能需要几秒钟</p>
            </div>
            <!-- 显示区域：初始显示HTML(隐藏)，生成后显示img -->
            <div id="summary-content" class="p-8 overflow-y-auto custom-scrollbar flex justify-center"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const itemConfig = {
                'rank-air-1': { label: '年度排名1 (播出)', type: 'subject' }, 
                'rank-end-1': { label: '年度排名1 (完结)', type: 'subject' },
                'rank-end-2': { label: '年度排名2 (完结)', type: 'subject' }, 
                'rank-end-3': { label: '年度排名3 (完结)', type: 'subject' },
                'char-female': { label: '女性角色', type: 'character' }, 
                'char-male': { label: '男性角色', type: 'character' },
                'char-other': { label: '其他角色', type: 'character' }, 
                'cp-1': { label: 'CP 1', type: 'character' }, 
                'cp-2': { label: 'CP 2', type: 'character' },
                'music-op': { label: 'OP', type: 'subject' }, 
                'music-ed': { label: 'ED', type: 'subject' }, 
                'music-in': { label: 'IN', type: 'subject' },
                'music-artist': { label: '歌手', type: 'person' }, 
                'staff-seiyuu-female': { label: '女性声优', type: 'person' },
                'staff-seiyuu-male': { label: '男性声优', type: 'person' },
            };

            // Initialize Containers
            const containers = document.querySelectorAll('.manual-container');
            containers.forEach(container => {
                const id = container.id;
                const config = itemConfig[id];
                if (!config) return;
                const showLabel = !container.dataset.labelHidden;
                container.innerHTML = `
                    ${showLabel ? `<label class="block text-sm font-medium text-gray-400 mb-1">${config.label}</label>` : ''}
                    <div class="relative manual-trigger group" data-target-id="${id}" data-api-type="${config.type}">
                        <img id="img-${id}" class="save-target-img w-full h-40 object-cover rounded-md bg-gray-700 hidden shadow-md">
                        <div id="placeholder-${id}" class="w-full h-40 rounded-md bg-gray-700/50 border-2 border-dashed border-gray-600 flex flex-col items-center justify-center placeholder-image cursor-pointer group-hover:border-indigo-500 transition-colors">
                             <svg class="w-8 h-8 text-gray-500 mb-1 group-hover:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                             <span class="text-gray-500 text-xs group-hover:text-indigo-300">点击添加</span>
                        </div>
                        <input type="hidden" id="data-name-${id}" class="save-target"><input type="hidden" id="data-img-${id}" class="save-target">
                    </div>`;
            });

            // --- Elements ---
            const smartModal = document.getElementById('smart-modal');
            const summaryModal = document.getElementById('summary-modal');
            const episodesContainer = document.getElementById('episodes-container');
            const generationLoader = document.getElementById('generation-loader');
            
            const yearInput = document.getElementById('year');
            const watchingCountInput = document.getElementById('watching-count');
            const watchedCountInput = document.getElementById('watched-count');
            const rewatchedCountInput = document.getElementById('rewatched-count');
            const totalWatchedInput = document.getElementById('total-watched');
            const usernameInput = document.getElementById('bangumi-username');
            const nicknameDisplay = document.getElementById('user-nickname');
            const avatarPreview = document.getElementById('user-avatar-preview');
            const avatarUrlHidden = document.getElementById('user-avatar-url');
            const syncStatus = document.getElementById('sync-status');
            const saveIndicator = document.getElementById('save-indicator');
            
            const syncBtn = document.getElementById('sync-user-btn');
            
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const apiIdInput = document.getElementById('api-id-input');
            const fetchApiBtn = document.getElementById('fetch-api-btn');
            const apiLoader = document.getElementById('api-loader');
            const apiPreview = document.getElementById('api-preview');
            const apiPreviewImg = document.getElementById('api-preview-img');
            const apiPreviewTitle = document.getElementById('api-preview-title');
            const apiError = document.getElementById('api-error');
            const confirmApiBtn = document.getElementById('confirm-api-btn');
            const manualConfirmBtn = document.getElementById('manual-confirm-btn');

            let currentTargetId = null;
            let currentApiType = 'subject'; 
            let episodeCounter = 0;
            let tempApiData = null; 

            // --- Caching Logic (LocalStorage) ---
            function saveState() {
                const state = {
                    inputs: {},
                    episodes: []
                };
                document.querySelectorAll('.save-target').forEach(el => {
                    state.inputs[el.id] = el.value;
                });
                document.querySelectorAll('.episode-entry').forEach((entry, index) => {
                    const idPart = entry.id.split('-')[1];
                    const animeId = `ep-anime-${idPart}`;
                    state.episodes.push({
                        name: document.getElementById(`data-name-${animeId}`)?.value || '',
                        img: document.getElementById(`data-img-${animeId}`)?.value || '',
                        number: document.getElementById(`ep-number-${idPart}`)?.value || ''
                    });
                });
                localStorage.setItem('bgm_summary_state', JSON.stringify(state));
                saveIndicator.classList.remove('hidden');
                setTimeout(() => saveIndicator.classList.add('hidden'), 2000);
            }

            function loadState() {
                const saved = localStorage.getItem('bgm_summary_state');
                if (!saved) return;
                try {
                    const state = JSON.parse(saved);
                    for (const [id, value] of Object.entries(state.inputs)) {
                        const el = document.getElementById(id);
                        if (el) {
                            el.value = value;
                            if (id.startsWith('data-img-') && value) {
                                const containerId = id.replace('data-img-', '');
                                const imgEl = document.getElementById(`img-${containerId}`);
                                const placeEl = document.getElementById(`placeholder-${containerId}`);
                                if (imgEl && placeEl) {
                                    imgEl.src = value;
                                    imgEl.classList.remove('hidden');
                                    placeEl.classList.add('hidden');
                                }
                            }
                        }
                    }
                    if (state.inputs['user-avatar-url']) {
                        avatarPreview.src = state.inputs['user-avatar-url'];
                    }
                    episodesContainer.innerHTML = '';
                    state.episodes.forEach(ep => addEpisode(ep));
                    calculateRewatched();
                } catch (e) { console.error("Failed to load state", e); }
            }

            document.body.addEventListener('input', (e) => {
                if (e.target.matches('input') || e.target.matches('.save-target')) { saveState(); }
            });
            const originalApply = applyItemData;
            applyItemData = function(name, imageUrl) {
                originalApply(name, imageUrl); 
                saveState();
            };
            loadState();

            // --- Sync Logic ---
            async function fetchUserStats(username, targetYear) {
                let finishedThisYear = 0; 
                let newShowsFinished = 0; 
                const limit = 50; 
                let page = 0;
                let hasMore = true;
                const maxPages = 100; 
                const targetYearInt = parseInt(targetYear, 10);

                while (hasMore && page < maxPages) {
                    try {
                        if (syncStatus) syncStatus.textContent = `正在扫描第 ${page + 1} 页历史数据...`;
                        const offset = page * limit;
                        const res = await fetch(`https://api.bgm.tv/v0/users/${username}/collections?subject_type=2&type=2&limit=${limit}&offset=${offset}`);
                        if (!res.ok) break;
                        const data = await res.json();
                        
                        if (data.data.length === 0) { hasMore = false; break; }

                        for (const item of data.data) {
                            const updated = item.updated_at || ""; 
                            const itemYearStr = updated.substring(0, 4);
                            const itemYearInt = parseInt(itemYearStr, 10);
                            
                            if (itemYearInt > targetYearInt) { continue; } 
                            else if (itemYearInt === targetYearInt) {
                                finishedThisYear++;
                                const airDate = item.subject?.date || "";
                                if (airDate.startsWith(targetYear)) { newShowsFinished++; }
                            } else if (itemYearInt < targetYearInt) { hasMore = false; break; }
                        }
                        if (data.data.length < limit) hasMore = false;
                        page++;
                    } catch (e) { console.error(e); break; }
                }
                return { finishedThisYear, newShowsFinished };
            }

            syncBtn.addEventListener('click', async () => {
                const username = usernameInput.value.trim();
                const targetYear = yearInput.value.toString();
                if (!username) { alert("请输入 Bangumi 用户名"); return; }
                
                const btnText = syncBtn.querySelector('.btn-text');
                const loader = syncBtn.querySelector('.loader');
                btnText.textContent = "同步中...";
                syncStatus.textContent = "正在连接 Bangumi...";
                loader.classList.remove('hidden');
                syncBtn.disabled = true;

                try {
                    const userRes = await fetch(`https://api.bgm.tv/v0/users/${username}`);
                    if (!userRes.ok) throw new Error("用户未找到");
                    const userData = await userRes.json();
                    
                    nicknameDisplay.value = userData.nickname;
                    avatarPreview.src = userData.avatar.large;
                    avatarUrlHidden.value = userData.avatar.large; 

                    const totalRes = await fetch(`https://api.bgm.tv/v0/users/${username}/collections?subject_type=2&type=2&limit=1`);
                    const totalData = await totalRes.json();
                    if (totalData.total !== undefined) { totalWatchedInput.value = totalData.total; }

                    syncStatus.textContent = `正在分析 ${targetYear} 年数据...`;
                    const stats = await fetchUserStats(username, targetYear);
                    watchedCountInput.value = stats.finishedThisYear;
                    watchingCountInput.value = stats.newShowsFinished;
                    
                    calculateRewatched();
                    saveState(); 
                    syncStatus.textContent = "同步完成！";
                } catch (error) {
                    syncStatus.textContent = "同步出错";
                    alert("同步失败: " + error.message);
                } finally {
                    btnText.textContent = "同步数据";
                    loader.classList.add('hidden');
                    syncBtn.disabled = false;
                    setTimeout(() => { syncStatus.textContent = ""; }, 5000);
                }
            });

            function calculateRewatched() {
                const watched = parseInt(watchedCountInput.value, 10) || 0;
                const watching = parseInt(watchingCountInput.value, 10) || 0;
                const diff = watched - watching;
                rewatchedCountInput.value = diff >= 0 ? diff : 0;
            }
            watchingCountInput.addEventListener('input', calculateRewatched);
            watchedCountInput.addEventListener('input', calculateRewatched);

            // --- Item Selection ---
            document.body.addEventListener('click', (e) => {
                const trigger = e.target.closest('.manual-trigger');
                if (trigger) {
                    currentTargetId = trigger.dataset.targetId;
                    currentApiType = trigger.dataset.apiType || 'subject'; 
                    apiIdInput.value = '';
                    apiPreview.classList.add('hidden');
                    apiError.classList.add('hidden');
                    document.getElementById('manual-name').value = document.getElementById(`data-name-${currentTargetId}`).value;
                    document.getElementById('manual-image-url').value = document.getElementById(`data-img-${currentTargetId}`).value;
                    switchTab('id');
                    smartModal.classList.remove('hidden');
                }
            });

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => { switchTab(btn.dataset.tab); });
            });

            function switchTab(tabName) {
                tabBtns.forEach(b => {
                    if (b.dataset.tab === tabName) {
                        b.classList.add('text-indigo-400', 'border-indigo-500');
                        b.classList.remove('text-gray-400');
                    } else {
                        b.classList.remove('text-indigo-400', 'border-indigo-500');
                        b.classList.add('text-gray-400');
                    }
                });
                tabContents.forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            }

            fetchApiBtn.addEventListener('click', async () => {
                const id = apiIdInput.value.trim();
                if (!id) return;
                apiLoader.classList.remove('hidden');
                apiError.classList.add('hidden');
                apiPreview.classList.add('hidden');
                tempApiData = null;
                try {
                    let endpoint = `https://api.bgm.tv/v0/subjects/${id}`;
                    if (currentApiType === 'character') endpoint = `https://api.bgm.tv/v0/characters/${id}`;
                    if (currentApiType === 'person') endpoint = `https://api.bgm.tv/v0/persons/${id}`;
                    const res = await fetch(endpoint, { headers: { 'User-Agent': 'BangumiYearReview/1.0' } });
                    if (!res.ok) throw new Error("ID 未找到或网络错误");
                    const data = await res.json();
                    const name = data.name_cn || data.name;
                    const img = data.images?.large || data.images?.medium || 'https://placehold.co/225x318/1f2937/374151?text=No+Img';
                    const finalImg = img.startsWith('//') ? `https:${img}` : img;
                    tempApiData = { name, img: finalImg };
                    apiPreviewImg.src = finalImg;
                    apiPreviewTitle.textContent = name;
                    apiPreview.classList.remove('hidden');
                } catch (err) {
                    apiError.textContent = err.message;
                    apiError.classList.remove('hidden');
                } finally {
                    apiLoader.classList.add('hidden');
                }
            });

            confirmApiBtn.addEventListener('click', () => {
                if (tempApiData) {
                    applyItemData(tempApiData.name, tempApiData.img);
                    smartModal.classList.add('hidden');
                }
            });

            manualConfirmBtn.addEventListener('click', () => {
                const name = document.getElementById('manual-name').value;
                const imageUrl = document.getElementById('manual-image-url').value;
                if (name && imageUrl) {
                    applyItemData(name, imageUrl);
                    smartModal.classList.add('hidden');
                } else {
                    const nameInput = document.getElementById('manual-name');
                    if (!name) nameInput.focus();
                    else document.getElementById('manual-image-url').focus();
                }
            });

            var applyItemData = function(name, imageUrl) {
                if (!currentTargetId) return;
                const img = document.getElementById(`img-${currentTargetId}`);
                const placeholder = document.getElementById(`placeholder-${currentTargetId}`);
                const nameInput = document.getElementById(`data-name-${currentTargetId}`);
                const imgInput = document.getElementById(`data-img-${currentTargetId}`);
                img.src = imageUrl;
                img.classList.remove('hidden');
                placeholder.classList.add('hidden');
                nameInput.value = name;
                imgInput.value = imageUrl;
                smartModal.classList.add('hidden');
            }

            // --- Episodes Logic ---
            function addEpisode(data = {}) {
                episodeCounter++;
                const animeId = `ep-anime-${episodeCounter}`;
                const entry = document.createElement('div');
                entry.className = 'episode-entry flex items-end space-x-4 p-3 bg-gray-700/50 rounded-lg border border-gray-600 mb-4';
                entry.id = `episode-${episodeCounter}`;
                const initialImg = data.img || '';
                const initialName = data.name || '';
                const initialNum = data.number || '';
                const imgDisplayClass = initialImg ? '' : 'hidden';
                const placeDisplayClass = initialImg ? 'hidden' : '';

                entry.innerHTML = `
                    <div class="w-1/3 manual-container">
                        <label class="block text-xs font-medium text-gray-400 mb-1">动画</label>
                        <div class="relative manual-trigger group" data-target-id="${animeId}" data-api-type="subject">
                            <img id="img-${animeId}" src="${initialImg}" class="save-target-img w-full h-24 object-cover rounded-md bg-gray-700 ${imgDisplayClass}">
                            <div id="placeholder-${animeId}" class="w-full h-24 rounded-md bg-gray-700 flex flex-col items-center justify-center placeholder-image cursor-pointer border border-dashed border-gray-500 hover:border-indigo-500 ${placeDisplayClass}">
                                 <span class="text-gray-500 text-xs">点击添加</span>
                            </div>
                            <input type="hidden" id="data-name-${animeId}" class="save-target" value="${initialName}">
                            <input type="hidden" id="data-img-${animeId}" class="save-target" value="${initialImg}">
                        </div>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-400 mb-1">集数</label>
                        <input type="number" id="ep-number-${episodeCounter}" class="save-target w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="Ep." value="${initialNum}">
                        <button class="text-red-400 text-xs mt-2 hover:underline" onclick="removeEpisode(this)">删除</button>
                    </div>
                `;
                episodesContainer.appendChild(entry);
            }
            window.removeEpisode = function(btn) { btn.closest('.episode-entry').remove(); saveState(); };
            document.getElementById('add-episode-btn').addEventListener('click', () => { addEpisode(); saveState(); });
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', () => { smartModal.classList.add('hidden'); summaryModal.classList.add('hidden'); });
            });

            // --- Generate Image Direct Logic ---
            const generateBtn = document.getElementById('generate-summary');
            
            generateBtn.addEventListener('click', async () => {
                // 1. Prepare Data
                const year = document.getElementById('year').value || '2025';
                const currentYearWatched = parseInt(watchingCountInput.value, 10) || 0;
                const totalWatchedThisYear = parseInt(watchedCountInput.value, 10) || 0;
                const rewatched = parseInt(rewatchedCountInput.value, 10) || 0;
                const total = parseInt(totalWatchedInput.value, 10) || 0;
                const username = usernameInput.value || 'Anonymous';
                const avatar = avatarPreview.src;
                const nickname = nicknameDisplay.value || username;

                const data = { 
                    year, watching: currentYearWatched, watched: totalWatchedThisYear, rewatched, total, username, nickname, avatar, items: {}, episodes: []
                };

                Object.keys(itemConfig).forEach(id => { 
                    data.items[id] = { 
                        label: itemConfig[id].label, 
                        name: document.getElementById(`data-name-${id}`).value, 
                        img: document.getElementById(`data-img-${id}`).value 
                    }; 
                });
                document.querySelectorAll('.episode-entry').forEach((entry) => {
                    const idPart = entry.id.split('-')[1]; 
                    const animeId = `ep-anime-${idPart}`;
                    const numInput = document.getElementById(`ep-number-${idPart}`);
                    if (numInput && document.getElementById(`data-name-${animeId}`)) {
                         data.episodes.push({
                            name: document.getElementById(`data-name-${animeId}`).value,
                            img: document.getElementById(`data-img-${animeId}`).value,
                            number: numInput.value
                        });
                    }
                });

                // 2. Render HTML to Container
                renderSummary(data);
                
                // 3. Show Modal with Loader
                summaryModal.classList.remove('hidden');
                generationLoader.classList.remove('hidden');
                
                // 4. Wait for images to load (short delay usually enough with weserv)
                // Using a small timeout to allow DOM layout to settle before capture
                setTimeout(async () => {
                    const element = document.querySelector('#summary-content > div');
                    if(!element) return;

                    try {
                        const canvas = await html2canvas(element, { 
                            useCORS: true, 
                            backgroundColor: null, 
                            scale: 2 // High resolution
                        });
                        
                        // 5. Replace HTML with Image
                        const img = new Image();
                        img.src = canvas.toDataURL('image/png');
                        img.className = "w-full h-auto rounded-lg shadow-2xl";
                        img.alt = "Bangumi Summary Image";
                        
                        const contentContainer = document.getElementById('summary-content');
                        contentContainer.innerHTML = ''; // Clear HTML
                        contentContainer.appendChild(img);
                        
                        generationLoader.classList.add('hidden'); // Hide loader
                        
                    } catch (err) {
                        console.error(err);
                        alert("图片生成失败，请检查网络或图片源跨域设置。\n依然显示 HTML 预览供截图。");
                        generationLoader.classList.add('hidden');
                    }
                }, 1000); // 1s delay for images
            });

            function renderSummary(data) {
                const placeholder = 'https://placehold.co/225x318/1f2937/374151?text=Empty';
                
                // Weserv Proxy for CORS
                const toCorsUrl = (url) => {
                    if (!url || url.startsWith('data:') || url.includes('placehold.co')) return url;
                    return `https://images.weserv.nl/?url=${encodeURIComponent(url)}&output=webp`;
                };

                // Updated Layout: Auto height for titles, more padding
                const getItemHTML = (id) => { 
                    const item = data.items[id]; 
                    if (!item) return ''; 
                    const img = item.img || placeholder; 
                    const name = item.name || '-'; 
                    return `
                    <div class="text-center group">
                        <p class="text-[10px] text-indigo-300 mb-1 uppercase tracking-wider">${item.label}</p>
                        <div class="overflow-hidden rounded-lg shadow-lg aspect-[3/4] mb-2 relative">
                            <img src="${toCorsUrl(img)}" class="w-full h-full object-cover transform group-hover:scale-105 transition duration-500" alt="${name}" crossorigin="anonymous">
                        </div>
                        <div class="min-h-[2rem] flex items-start justify-center pt-1">
                            <p class="text-xs font-bold text-gray-200 title-text leading-tight">${name}</p>
                        </div>
                    </div>`; 
                };

                const getCpHTML = () => {
                    const i1 = data.items['cp-1'], i2 = data.items['cp-2'];
                    const img1 = i1.img || placeholder, n1 = i1.name || '';
                    const img2 = i2.img || placeholder, n2 = i2.name || '';
                    return `
                    <div class="col-span-2 md:col-span-1 text-center">
                         <p class="text-[10px] text-pink-300 mb-1 uppercase tracking-wider">最佳 CP</p>
                         <div class="flex justify-center items-end h-32 md:h-40 relative">
                             <img src="${toCorsUrl(img1)}" class="w-20 h-28 md:w-24 md:h-32 object-cover rounded-lg shadow-xl z-10 transform -rotate-6 border-2 border-gray-800" alt="${n1}" crossorigin="anonymous">
                             <img src="${toCorsUrl(img2)}" class="w-20 h-28 md:w-24 md:h-32 object-cover rounded-lg shadow-xl transform rotate-6 ml-[-15px] border-2 border-gray-800" alt="${n2}" crossorigin="anonymous">
                         </div>
                         <div class="min-h-[2rem] flex items-start justify-center pt-2">
                            <p class="text-xs font-bold text-pink-100 title-text leading-tight">${n1} & ${n2}</p>
                         </div>
                    </div>`;
                };

                const getEpHTML = (ep) => `
                    <div class="text-center">
                        <div class="overflow-hidden rounded-md shadow aspect-video mb-1">
                            <img src="${toCorsUrl(ep.img || placeholder)}" class="w-full h-full object-cover" crossorigin="anonymous">
                        </div>
                        <div class="min-h-[1.5rem] flex items-start justify-center pt-1">
                            <p class="text-[10px] font-bold text-gray-300 title-text leading-tight">${ep.name}</p>
                        </div>
                        <p class="text-[10px] text-indigo-400">Ep.${ep.number}</p>
                    </div>`;

                const episodesSection = data.episodes.length > 0 ? `
                    <div class="mt-6 pt-4 border-t border-gray-700/50">
                        <h3 class="text-sm font-bold text-gray-400 mb-3 text-center">年度单集</h3>
                        <div class="grid grid-cols-4 md:grid-cols-6 gap-3">
                            ${data.episodes.map(getEpHTML).join('')}
                        </div>
                    </div>` : '';

                document.getElementById('summary-content').innerHTML = `
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 text-white p-8 rounded-xl shadow-2xl relative overflow-hidden w-full max-w-[700px] mx-auto">
                        <!-- Header -->
                        <div class="flex items-center space-x-4 mb-8 relative z-10">
                            <img src="${toCorsUrl(data.avatar)}" class="w-16 h-16 rounded-full border-4 border-indigo-500 shadow-lg" crossorigin="anonymous">
                            <div>
                                <h2 class="text-3xl font-black italic tracking-tighter">${data.year}</h2>
                                <p class="text-sm text-indigo-300 font-medium tracking-wide">ANIMATION YEAR IN REVIEW</p>
                                <p class="text-xs text-gray-500 mt-0.5">@${data.nickname}</p>
                            </div>
                            <div class="ml-auto flex space-x-6 text-right">
                                <div><p class="text-2xl font-bold text-white">${data.watching}</p><p class="text-[10px] text-gray-400 uppercase">追番(${data.year}完结)</p></div>
                                <div><p class="text-2xl font-bold text-white">${data.watched}</p><p class="text-[10px] text-gray-400 uppercase">看番(${data.year}完成)</p></div>
                                <div><p class="text-2xl font-bold text-indigo-400">${data.total}</p><p class="text-[10px] text-gray-400 uppercase">累计</p></div>
                            </div>
                        </div>

                        <!-- Grid: Anime | Characters | Music -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 relative z-10">
                            <!-- Col 1: Anime (4 items) -->
                            <div class="space-y-4">
                                <h3 class="text-xs font-bold text-gray-500 uppercase border-b border-gray-700 pb-1">Top Anime</h3>
                                <div class="grid grid-cols-2 gap-3">
                                    ${getItemHTML('rank-air-1')}${getItemHTML('rank-end-1')}
                                    ${getItemHTML('rank-end-2')}${getItemHTML('rank-end-3')}
                                </div>
                            </div>
                            
                            <!-- Col 2: Characters & CP (3 items + CP) -->
                            <div class="space-y-4">
                                <h3 class="text-xs font-bold text-gray-500 uppercase border-b border-gray-700 pb-1">Characters</h3>
                                <div class="grid grid-cols-2 gap-3">
                                    ${getItemHTML('char-female')}${getItemHTML('char-male')}
                                    ${getItemHTML('char-other')}
                                </div>
                                ${getCpHTML()}
                            </div>

                            <!-- Col 3: Music (4 items) -->
                            <div class="space-y-4">
                                <h3 class="text-xs font-bold text-gray-500 uppercase border-b border-gray-700 pb-1">Music</h3>
                                <div class="grid grid-cols-2 gap-3">
                                    ${getItemHTML('music-op')}${getItemHTML('music-ed')}
                                    ${getItemHTML('music-in')}${getItemHTML('music-artist')}
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Voice Actors (Separate Row) -->
                        <div class="mt-6 relative z-10">
                            <h3 class="text-xs font-bold text-gray-500 uppercase border-b border-gray-700 pb-1 mb-4 text-center">Voice Actors</h3>
                            <div class="flex justify-center gap-6">
                                <div class="w-1/3 md:w-1/4">${getItemHTML('staff-seiyuu-female')}</div>
                                <div class="w-1/3 md:w-1/4">${getItemHTML('staff-seiyuu-male')}</div>
                            </div>
                        </div>

                        ${episodesSection}

                        <!-- Footer Decoration -->
                        <div class="absolute -bottom-10 -right-10 w-64 h-64 bg-indigo-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
                        <div class="absolute -top-10 -left-10 w-64 h-64 bg-pink-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20"></div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>